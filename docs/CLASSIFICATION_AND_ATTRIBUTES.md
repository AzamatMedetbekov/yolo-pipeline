# Fridge Classification & Attribute Prediction (Stage 2)

This document describes Stage 2 of the pipeline: classifying refrigerator types and predicting attributes (power, volume, etc.) from cropped images.

## Overview

Stage 2 analyzes the Region of Interest (ROI) crops generated by the segmentation model (Stage 1). It supports two tasks:
1.  **Type Classification**: Classifying the fridge into 6 categories (e.g., vertical, horizontal).
2.  **Attribute Prediction**: Predicting technical specifications (mix of regression and classification).

These tasks can be trained separately or jointly using a unified training script.

## 1. Dataset Preparation

### Data Structure
Images should be organized in `data/images/train` and `data/images/val`. Labels are provided via CSV files.

### CSV Format
The training script expects a CSV file with the following columns:
-   `image_name`: Filename (e.g., `test1.jpg`)
-   `split`: `train` or `val`
-   `type_class`: Integer (0-5) for type classification
-   `attrX_...`: Columns for attributes (see below)

Use the helper tools to generate templates:
```bash
python tools/make_type_template.py    # Generates data/fridge_type_labels.csv
python tools/make_attr_template.py    # Generates data/fridge_attr10_labels.csv
```

## 2. Training

The script `scripts/train_fridge_attr+type_.py` handles training for both tasks.

### Modes
-   `--mode type`: Train only type classifier.
-   `--mode attr`: Train only attribute predictor.
-   `--mode both`: Train both (multi-task learning).

### Configuration
Configs are located in `configs/`:
-   `configs/fridge_type.yaml`: Settings for type classification.
-   `configs/fridge_attr.yaml`: Settings for attribute prediction.

### Running Training

**Train Type Classifier:**
```bash
python scripts/train_fridge_attr+type_.py \
    --mode type \
    --config configs/fridge_type.yaml \
    --epochs 50
```

**Train Attribute Predictor:**
```bash
python scripts/train_fridge_attr+type_.py \
    --mode attr \
    --config configs/fridge_attr.yaml \
    --epochs 200
```

**Train Jointly (Multi-task):**
```bash
python scripts/train_fridge_attr+type_.py \
    --mode both \
    --csv data/combined_labels.csv \
    --epochs 100
```

### Key Arguments
-   `--data`: Data root directory (default: `data`).
-   `--csv`: Path to labels CSV.
-   `--imgsz`: Input image size (default: 224 for ResNet).
-   `--batch`: Batch size (default: 8).
-   `--device`: GPU device (e.g., `0` or `cpu`).
-   `--output`: Output directory for checkpoints.

## 3. Inference

Separate scripts are provided for inference on single images.

### Type Classification
```bash
python inference/infer_fridge_type.py \
    --weights runs/type/train/best.pt \
    --image path/to/crop.jpg
```

**Output:**
-   Predicted class index and label (e.g., "vertical").
-   Confidence score.

### Attribute Prediction
```bash
python inference/infer_fridge_attr.py \
    --weights runs/attr/train/best.pt \
    --image path/to/crop.jpg
```

**Output:**
-   **Regression**: Values for power, volume, year, etc. (automatically unscaled).
-   **Classification**: Labels for refrigerant, door type, etc.

## 4. Model Architecture

Both tasks use a **ResNet-18** backbone initialized with ImageNet weights.

-   **TypeNet**: ResNet-18 + Linear Head (6 classes).
-   **AttrNet**: ResNet-18 + Multiple Heads:
    -   `reg_head`: Linear layer for all regression attributes.
    -   `cls_heads`: ModuleDict of Linear layers for each classification attribute.

## 5. Attributes Detail

### Type Classes (0-5)
0.  vertical
1.  horizontal
2.  vertical_open
3.  horizontal_open
4.  combination
5.  coldroom

### Regression Attributes
-   `attr1_power_kw`
-   `attr2_u_value`
-   `attr3_internal_volume` (Scaled by 1000 during training)
-   `attr4_temp_class`
-   `attr8_year` (Shifted by 2000, scaled by 50)
-   `attr10_misc`

### Classification Attributes
-   `attr5_refrigerant`: R404A, R134a, R290
-   `attr6_door_type`: Sliding, Swing, Open
-   `attr7_cabinet_type`: Vertical, Face-to-face
-   `attr9_insulation_type`: PU Foam, Other
